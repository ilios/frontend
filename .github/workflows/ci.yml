name: Continuous Integration

on:
  push:
    branches:
      - master
  pull_request: {}

concurrency:
  group: ci-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  SW_DISABLED: true

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install
      - name: Lint
        run: pnpm run lint
      - name: Test Dependency Installation
        run: pnpm install --resolution-only --no-frozen-lockfile

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [lint]
    env:
      ENABLE_A11Y_AUDIT: true
    strategy:
      fail-fast: false
      matrix:
        node-version: [24]
        workspace:
          - frontend
          - test-app
          - lti-course-manager
          - lti-dashboard
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install
      - name: Run Tests
        run: pnpm --filter ${{matrix.workspace}} exec ember exam --parallel=3 --load-balance --write-execution-file

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        node-version: [24]
        workspace:
          - frontend
          - test-app
          - lti-course-manager
          - lti-dashboard
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm
      - name: install dependencies
        run: pnpm install
      - name: Build
        run: pnpm --filter ${{matrix.workspace}} run build

  test-deploy-build:
    name: Test Deploy Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        node-version: [24]
        workspace:
          - frontend
          - lti-course-manager
          - lti-dashboard
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm
      - name: install dependencies
        run: pnpm install
      - name: Test ${{matrix.workspace}} Deploy
        run: pnpm --filter ${{matrix.workspace}} run deploy:test

  sonarqube_scan:
    name: Scan with UCSF SonarQube
    runs-on: ubuntu-latest
    needs: [test]
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0 # disable shallow clone for full access to code
      - uses: sonarsource/sonarqube-scan-action@v7
        if: ${{ env.SONAR_TOKEN != '' }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: https://sonarqube.ucsf.edu
        with:
          # https://community.sonarsource.com/t/xml-file-extension-is-binded-to-multiple-language/41745/4
          args: >
            -Dsonar.projectKey=ilios_frontend_27a24e39-b0ec-405a-91a6-b6392ffcdd30

  cache-baseline:
    name: Cache Baseline (${{ matrix.name }})
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/master' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: phone
            width: 399
          - name: tablet
            width: 768
          - name: laptop
            width: 1200
          - name: desktop
            width: 1920
    env:
      MOZ_HEADLESS_WIDTH: ${{ matrix.width }}
    steps:
      - uses: actions/checkout@v6
      - name: Cache Screenshots
        id: screenshot-cache
        uses: actions/cache@v5
        with:
          path: build
          key: screenshots-${{ github.sha }}-${{ matrix.name }}
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: pnpm install
      - name: Capture Screenshots
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: pnpm --filter frontend exec ember exam --parallel=3 --load-balance --config-file=testem.screenshots.js
      - name: Rename screenshots
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: |
          cd build/screenshots
          for file in *; do
            mv "$file" "${{ matrix.name }}-$file"
          done
