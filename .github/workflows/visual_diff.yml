name: Visual Diff

on:
  pull_request: {}

concurrency:
  group: visual-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

permissions:
  pull-requests: write

env:
  SW_DISABLED: true

jobs:
  baseline:
    name: Baseline (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: phone
            width: 399
          - name: tablet
            width: 768
          - name: laptop
            width: 1200
          - name: desktop
            width: 1920
    env:
      MOZ_HEADLESS_WIDTH: ${{ matrix.width }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: "master"
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install
      - name: Capture Screenshots
        run: pnpm --filter frontend exec ember exam --parallel=3 --load-balance --config-file=testem.screenshots.js
      - name: Rename screenshots
        run: |
          cd build/screenshots
          for file in *; do
            mv "$file" "${{ matrix.name }}-$file"
          done
      - uses: actions/upload-artifact@v5
        with:
          name: baseline-frontend-${{ matrix.name }}
          path: build/screenshots

  candidate:
    name: Candidate (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: phone
            width: 399
          - name: tablet
            width: 768
          - name: laptop
            width: 1200
          - name: desktop
            width: 1920
    env:
      MOZ_HEADLESS_WIDTH: ${{ matrix.width }}
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
      - name: Install Dependencies
        run: pnpm install
      - name: Capture Screenshots
        run: pnpm --filter frontend exec ember exam --parallel=3 --load-balance --config-file=testem.screenshots.js
      - name: Rename screenshots
        run: |
          cd build/screenshots
          for file in *; do
            mv "$file" "${{ matrix.name }}-$file"
          done
      - uses: actions/upload-artifact@v5
        with:
          name: candidate-frontend-${{ matrix.name }}
          path: build/screenshots

  compare:
    name: Visual Diff
    needs: [baseline, candidate]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v6
        with:
          pattern: baseline-frontend-*
          path: baseline-frontend
          merge-multiple: true
      - uses: actions/download-artifact@v6
        with:
          pattern: candidate-frontend-*
          path: candidate-frontend
          merge-multiple: true
      - run: ls -lh baseline-frontend candidate-frontend
      - uses: actions/setup-node@v6
        with:
          node-version: 24
      - name: Create Visual Diff
        id: visual_diff
        run: |
          output=$(npx visual-differ baseline-frontend candidate-frontend results/visual-diff-${{ github.event.pull_request.number }})
          echo "$output"
          {
            echo "visual_diff_output<<EOF"
            echo "$output"
            echo "EOF"
          } >> $GITHUB_ENV
      - uses: actions/upload-artifact@v5
        id: upload_results
        if: always()
        with:
          name: VisualDiffResults
          path: results
      - name: Comment on Pull Request
        if: always()
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            **Visual Diff Results**

            Output:
            ```
            ${{ env.visual_diff_output }}
            ```

            [Download Visual Diff Results](${{ steps.upload_results.outputs.artifact-url }})
