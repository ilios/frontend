name: Visual Diff

on:
  pull_request: {}

concurrency:
  group: visual-diff-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  SW_DISABLED: true

jobs:
  baseline:
    name: Baseline (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: phone
            width: 399
          - name: tablet
            width: 768
          - name: laptop
            width: 1200
          - name: desktop
            width: 1920
    env:
      MOZ_HEADLESS_WIDTH: ${{ matrix.width }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: "master"
      - name: Cache Screenshots
        id: screenshot-cache
        uses: actions/cache@v5
        with:
          path: build
          key: screenshots-${{ github.sha }}-${{ matrix.name }}
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: pnpm install
      - name: Capture Screenshots
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: pnpm --filter frontend exec ember exam --parallel=3 --load-balance --config-file=testem.screenshots.js
      - name: Rename screenshots
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: |
          cd build/screenshots
          for file in *; do
            mv "$file" "${{ matrix.name }}-$file"
          done
      - uses: actions/upload-artifact@v6
        with:
          name: baseline-frontend-${{ matrix.name }}
          path: build/screenshots

  candidate:
    name: Candidate (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: phone
            width: 399
          - name: tablet
            width: 768
          - name: laptop
            width: 1200
          - name: desktop
            width: 1920
    env:
      MOZ_HEADLESS_WIDTH: ${{ matrix.width }}
    steps:
      - uses: actions/checkout@v6
      - name: Cache Screenshots
        id: screenshot-cache
        uses: actions/cache@v5
        with:
          path: build
          key: screenshots-${{ github.event.pull_request.head.sha }}-${{ matrix.name }}
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm
      - name: Install Dependencies
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: pnpm install
      - name: Capture Screenshots
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: pnpm --filter frontend exec ember exam --parallel=3 --load-balance --config-file=testem.screenshots.js
      - name: Rename screenshots
        if: steps.screenshot-cache.outputs.cache-hit != 'true'
        run: |
          cd build/screenshots
          for file in *; do
            mv "$file" "${{ matrix.name }}-$file"
          done
      - uses: actions/upload-artifact@v6
        with:
          name: candidate-frontend-${{ matrix.name }}
          path: build/screenshots

  compare:
    name: Visual Diff
    needs: [baseline, candidate]
    runs-on: ubuntu-latest
    env:
      OUTPUT_DIR: visual-diff-${{ github.event.pull_request.number }}
    steps:
      - uses: actions/download-artifact@v7
        with:
          pattern: baseline-frontend-*
          path: baseline-frontend
          merge-multiple: true
      - uses: actions/download-artifact@v7
        with:
          pattern: candidate-frontend-*
          path: candidate-frontend
          merge-multiple: true
      - run: ls -lh baseline-frontend candidate-frontend
      - uses: actions/setup-node@v6
        with:
          node-version: 24
      - run: |
          mkdir -p ./results
          echo ${{ github.event.pull_request.number }} > ./results/pr_number
      - name: Create Visual Diff
        run: npx visual-differ baseline-frontend candidate-frontend ${{ env.OUTPUT_DIR }} > results/visual-diff.txt
      - if: always()
        run: cp ${{ env.OUTPUT_DIR }}/report.md results/
      - if: always()
        run: cat results/report.md results/visual-diff.txt
      - uses: actions/upload-artifact@v6
        id: upload-output
        if: always()
        with:
          name: ${{ env.OUTPUT_DIR }}
          path: ${{ env.OUTPUT_DIR }}
      - if: always()
        run: echo ${{ steps.upload-output.outputs.artifact-url }} > ./results/artifact_url
      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: results
          path: results
